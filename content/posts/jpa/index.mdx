---
title: JPA ì„¸íŒ…í•˜ê¸° ğŸ› ï¸
date: 2022-11-15
description: Spring Boot + MySQL + JPA + Flyway ì„¸íŒ… ê³¼ì •ì„ ì •ë¦¬í•´ë´…ë‹ˆë‹¤.
tags:
  - ê°œë°œ
banner: ./hexo_blog.png
---
# Motivation

ì €ëŠ” JPAë¥¼ ì¨ë³¸ì ì´ ì—†ëŠ”ë°ìš”. JPAë¥¼ ì‚¬ìš©í•´ë³¸/í•˜ê³ ìˆëŠ” ì‚¬ëŒë“¤ì—ê²Œ JPAë¥¼ ì„¤ëª…í•´ë‹¬ë¼ê³  í•˜ë©´ "í•˜... ë„ˆë„¨ ì´ëŸ°ê±° í•˜ì§€ë§ˆë¼ ğŸš¬" ëŠë‚Œìœ¼ë¡œë‹¤ê°€ ë³„ë¡œë¼ê³  ë§í•´ì£¼ê³¤ í•˜ë”ë¼êµ¬ìš”.
í•˜ì§€ ë§ë¼ê³  í•˜ë©´ ë” í•´ë³´ê³  ì‹¶ì–´ì„œ í•œ ë²ˆ ê°„ë‹¨í•œ ìƒ˜í”Œì„ ë„ì›Œë³´ê¸°ë¡œ í–ˆìŠµë‹ˆë‹¤.
***
# Spring Initializer ë¡œ í”„ë¡œì íŠ¸ ë¼ˆëŒ€ ìƒì„±

[Initializer](https://start.spring.io/)ë¡œ í”„ë¡œì íŠ¸ ë¼ˆëŒ€ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

ì–¸ì–´ ì˜µì…˜ ì¤‘ Kotlinì´ ì•„ì£¼ ì ê¹ ê¶ê¸ˆí–ˆìœ¼ë‚˜ ì˜ ì°¸ê³  Javaë¥¼ ê³ ë¦…ë‹ˆë‹¤ ã…ã… ì™œëƒë©´ ì•„ì§ Javaë„ ì•„ì§ ì˜ëª¨ë¥´ê¸° ë•Œë¬¸ì´ì£  ğŸ¤¦â€â™€ï¸
DependencyëŠ” ê°ì í•„ìš”í•œ ê²ƒì„ ì„ íƒí•˜ë©´ ë˜ëŠ”ë°, ì €ëŠ” Lombok, JPA, Flyway, Web ì„ ê³¨ëìŠµë‹ˆë‹¤.

# Application.yaml ì„¤ì •

Initializerë¡œ ë§Œë“  í´ë” ì•ˆì—ëŠ” application.propertiesê°€ ê¸°ë³¸ìœ¼ë¡œ ìƒì„±ë˜ì–´ìˆìœ¼ë‚˜ ì €ëŠ” ê°€ë…ì„± ë•Œë¬¸ì— yaml í¬ë§·ì„ ì„ í˜¸í•˜ë¯€ë¡œ application.yaml íŒŒì¼ì„ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤.
ì•„ë˜ì™€ ê°™ì´ application.yamlë¥¼ ì„¤ì •í•´ì£¼ë©´ `MySQL - JPA - flyway` ëŠ” ì˜ ì—°ë™ì´ ë©ë‹ˆë‹¤.

```yaml
server:
  address: localhost
  port: 8080

spring:
  flyway:
    enabled: true
    locations: classpath:db/migration
    schemas: coworksaga
    baseline-on-migrate: true
    url: &db-url jdbc:mysql://localhost:3306/coworksaga?useSSL=false&useUnicode=true&characterEncoding=UTF-8&serverTimezone=Asia/Seoul&createDatabaseIfNotExist=true&allowPublicKeyRetrieval=true
    user: &db-user coworksaga
    password: &db-pwd root1234
    create-schemas: true
  jpa:
    database: mysql
    hibernate:
      ddl-auto: validate
    show-sql: true
    format-sql: true
    use-sql-comments: true
    properties:
      hibernate:
        temp:
          use_jdbc_metadata_defaults: false
  datasource:
      url: *db-url
      username: *db-user
      password: *db-pwd
      driver-class-name: com.mysql.cj.jdbc.Driver


logging:
  level:
    org.hibernate.SQL: DEBUG
    org.hibernate.type: TRACE
```
+) ê¹¨ë‹¬ì€ì 

- &, * í˜ì–´ë¡œ ë³€ìˆ˜ë¥¼ ì„ ì–¸í•˜ê³  ë¶ˆëŸ¬ë‹¤ ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤. êµ¿êµ¿
- DB ìŠ¤í‚¤ë§ˆê°€ ì—†ì„ë•Œ ìë™ìœ¼ë¡œ ìƒì„±í•˜ë„ë¡ í•˜ê¸° ìœ„í•´ì„œëŠ” jdbc urlì— `createDatabaseIfNotExist=true` ì˜µì…˜ì„ ì£¼ë©´ ë©ë‹ˆë‹¤.
- JPAë¥¼ ì‚¬ìš©í•˜ë©´ ê¸°ë³¸ ì˜µì…˜ìœ¼ë¡œ ì„œë²„ê°€ ëœ°ë•Œ ìë™ìœ¼ë¡œ DB Connectionì„ ë§ºì–´ì£¼ëŠ”ë°ìš”. ìœ„ì—ì„œ ë§í•œëŒ€ë¡œ ì €ëŠ” ì„œë²„ ê¸°ë™ ì‹œì ì— DB ìŠ¤í‚¤ë§ˆê°€ ì—†ëŠ” ìƒí™©ì„ ê°€ì •í•˜ê³  jdbc urlì— ì˜µì…˜ì„ ì¤¬ìœ¼ë¯€ë¡œ ì´ ê¸°ë³¸ ë™ì‘ì„ êº¼ì¤˜ì•¼í•©ë‹ˆë‹¤. [baeldung ì•„í‹°í´](https://www.baeldung.com/spring-data-jpa-run-app-without-db) ì— ë‚´ìš© ë° ì„¤ì • ë°©ë²•ì´ ì˜ ì„¤ëª…ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
- JPAì— ëŒ€í•´ ì •ë§ ì§€ì‹ì´ ì—†ì–´ì„œ... ë‹¨ìˆœíˆ íŠ¹ì • ê·œì¹™ì„ ê°€ì§„ ë©”ì†Œë“œ ëª…ìœ¼ë¡œ ì¿¼ë¦¬ ë§Œë“¤ì–´ì£¼ëŠ” ê¸°ëŠ¥ë§Œ í•˜ëŠ” ì¤„ ì•Œì•˜ëŠ”ë°, DDL ìë™ ìƒì„± ê¸°ëŠ¥ë„ ìˆì–´ì„œ ì‹ ê¸°í–ˆìŠµë‹ˆë‹¤. ì˜¤íˆë ¤ ë¶ˆí¸í•  ê²ƒ ê°™ë‹¤ëŠ” ìƒê°ì´ ë“¤ì–´ êº¼ë‘ì—ˆì§€ë§Œìš” ã…ã…


+) ê¶ê¸ˆí•œì 

- ë¹„ìŠ·í•œ ì¹´í…Œê³ ë¦¬ ê°™ì€ë° ì™œ depthê°€ ì™œ ë‹¤ë¥¸ê±¸ê¹Œìš”? jpa.hibernateë‘ jpa.properties.hibernate ì²˜ëŸ¼.
- url username passwork ì´ê±° ë‹¤ datasource, flywayì— ë‘ ë²ˆì”© ì“°ê²Œ ë˜ì–´ìˆëŠ”ë°.. ë³€ìˆ˜ë¡œ ì •ë¦¬í•´ë‘ê¸´ í–ˆìœ¼ë‚˜, ë‘ ì˜µì…˜ì´ í•œ ê°’ì„ ë°”ë¼ë³´ë„ë¡ ë°”ë¡œ ì„¤ì •ì€ ì•ˆë˜ëŠ”ê±¸ê¹Œìš”?



# Layer ë³„ í´ë” íŠ¸ë¦¬ ìƒì„±

ì´ì œ ë¡œì»¬ì— ì„œë²„ë¥¼ ë„ìš¸ ìˆ˜ ìˆëŠ” ìƒíƒœê°€ ë˜ì—ˆìœ¼ë‹ˆ ì‹¤ì œë¡œ ê¸°ëŠ¥ ê°œë°œì„ í•  ìˆ˜ ìˆë„ë¡ í´ë”ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
ë§¤ë²ˆ Layer (Controller, Service, Repository) ë³„ë¡œ í´ë”ë§ì„ í–ˆëŠ”ë° ë¬¸ë“ ë‹¤ë¥¸ ì‚¬ëŒë“¤ì€ ì–´ì©Œê³  ìˆë‚˜ ì‹¶ì–´ ì°¾ì•„ë³´ë‹ˆ Entity/Domainë³„ë¡œ ë¬¶ëŠ” ë°©ë²•ë„ ì“°ì´ê³  ìˆë„¤ìš”. ì‚¬ì‹¤ í´ë”ë¡œ ë¬¶ìœ¼ë©´ í•œ íŒ¨í‚¤ì§€ê°€ ë˜ë‹ˆ, íŒ¨í‚¤ì§€ë‘ ë§¥ë½ì´ ë¹„ìŠ·í•œ ê°œë…ì€ Layerë³´ë‹¨ Entity/Domainì¸ ê²ƒ ê°™ê¸°ë„ í•˜ê³  ê³ ë¯¼ì´ ë˜ê¸´ í•©ë‹ˆë‹¤. ê·¸ë ‡ë‹¤ê³  ì‹¤ì œë¡œ íŒ¨í‚¤ì§€ë³„ë¡œ ë”°ë¡œ ë¬¶ì–´ì„œ ë°°í¬/ê³µìœ í•˜ëŠ” ê²ƒë„ ì•„ë‹ˆë‹ˆ ìƒê°ë³´ë‹¤ ì—„ì²­ë‚˜ê²Œ ë©”ë¦¬íŠ¸ê°€ ìˆì„ ê²ƒ ê°™ì§€ ì•Šê¸°ëŠ” í•˜ì§€ë§Œìš”. ìš°ì„  ì´ë²ˆì—ë„ Layerë¡œ í´ë”ë¥¼ ë‚˜ëˆ„ë„ë¡ í•©ë‹ˆë‹¤.



# ì²«ë²ˆì§¸ flyway ìŠ¤í¬ë¦½íŠ¸ì™€ REST api ë§Œë“¤ê¸°

ì´ì œ ì²«ë²ˆì§¸ REST APIë¥¼ ë§Œë“¤ì–´ë´…ë‹ˆë‹¤.
uuidë¥¼ ë„˜ê¸°ë©´ workspace ì´ë¦„ì„ ì¡°íšŒí•˜ëŠ” APIì´ë©°, ê·¸ëŸ¬ë ¤ë©´ ìš°ì„  workspace í…Œì´ë¸”ì„ ìƒì„±í•´ì£¼ì–´ì•¼í•˜ê² ìŠµë‹ˆë‹¤.

- V0_1_0__create_workspaces.sql

  ```sql
  CREATE TABLE workspaces (
  	workspace_id INT UNSIGNED auto_increment NOT NULL PRIMARY KEY,
  	workspace_name varchar(100) NOT NULL,
  	workspace_uuid varchar(36) NOT NULL,
  	workspace_password varchar(10) NULL,
  	created_at DATETIME NOT NULL DEFAULT NOW(),
  	updated_at DATETIME NOT NULL DEFAULT NOW() ON UPDATE NOW()
  )
  ENGINE=InnoDB
  DEFAULT CHARSET=utf8mb4
  COLLATE=utf8mb4_unicode_ci
  ```

- V0_1_1__insert_workspaces.sql

  ```sql
  INSERT INTO workspaces
  (workspace_id, workspace_name, workspace_uuid, workspace_password, created_at, updated_at)
  VALUES(1, "HYEON's workspace", '2a2ba386-1ca1-49c6-8573-076916ac6139', 'Password', now(), now());
  ```



ì´ì œ Entityë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

- Workspace

  ```java
  @Entity
  @Table(name = "workspaces")
  @Builder
  @AllArgsConstructor
  @NoArgsConstructor
  @Getter
  public class Workspace {
      @Id
      private Integer id;
      private String name;
      @Column(name = "uuid", unique = true)
      private String uuid;
      private String password;
      private String createdAt;
      private String updatedAt;
  }
  ```

ê·¸ë¦¬ê³  ì°¨ë¡€ëŒ€ë¡œ Repository, Service, Controllerë¥¼ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤.

- WorkspaceRepository

  ```java
  @Repository
  public interface WorkspaceRepository extends JpaRepository<Workspace, Integer> {
      Workspace findByUuid(String uuid);
  }
  ```

- WorkspaceService

  ```java
  @Service
  @RequiredArgsConstructor
  public class WorkspaceService {
      private final WorkspaceRepository workspaceRepository;
  
      public Workspace getWorkspace(String uuid) {
          return workspaceRepository.findByUuid(uuid);
      }
  }
  ```

- WorkspaceController

  ```java
  @RestController
  @RequiredArgsConstructor
  public class WorkspaceController {
      private final WorkspaceService workspaceService;
  
      @GetMapping("/workspaces/{uuid}")
      public Workspace workspaceDetail(@PathVariable @Length(min=16, max=16) String uuid) {
          return workspaceService.getWorkspace(uuid);
      }
  }
  ```



+) ì¿¼ë¦¬ ê²°ê³¼ëŠ” ì •ìƒì ì´ì§€ë§Œ API ì‘ë‹µì´ ê·¸ëƒ¥  `{}` ë¡œ ë–¨ì–´ì§€ëŠ” ê²½ìš°
- return í•œ Entityì— public getterê°€ ì—†ì–´ì„œ ê·¸ëŸ´ ìˆ˜ ìˆìŠµë‹ˆë‹¤. [ì°¸ê³ ](https://stackoverflow.com/questions/49117622/spring-rest-controller-returns-empty-json-iterable-data-structure-why)

# ë§ˆì¹˜ë©°

- ì²˜ìŒë¶€í„° í•´ë³´ë©´ ë¨¸ë¦¬ì— í™•ì‹¤íˆ ì˜ ë“¤ì˜¤ëŠ” ê²ƒ ê°™ìŠµë‹ˆë‹¤ ğŸ‘ get api í•˜ë‚˜ ë§Œë“œëŠ”ë° ìƒê°ë³´ë‹¤ ë§ì€ ê²ƒì„ ë°°ì› ë„¤ìš”.
- ë„ˆë¬´ ê°„ë‹¨í•œ ì˜ˆì œë§Œ ë§Œë“¤ì–´ì„œ ì•„ì§ì€ ì™œ "í•˜... ë„ˆë„¨ ì´ëŸ°ê±°(JPA) í•˜ì§€ë§ˆë¼ ğŸš¬" í•˜ëŠ”ê±´ ì§€ ëª» ëŠê¼ˆì–´ìš”. ë” ì¨ë´ì•¼ë˜ê² ìŠµë‹ˆë‹¤.